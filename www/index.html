<!doctype html>
<html lang="fr">
<head>
<title>Color sequences viewer</title>
<meta charset="utf-8">

<!-- STYLES -->
<link rel="stylesheet"
	href="http://openlayers.org/en/v3.17.1/css/ol.css" type="text/css">
<style>
body, html {
	margin: 0;
	padding: 0;
	height: 100%;
}

#mapview {
	float: left;
	width: 50%;
	height: 100%;
	background-color: #C0C0C0;
}

#sRGBView {
	float: right;
	width: 50%;
	height: 100%;
	background-color: #C0C0C0;
}

.application {
	width: 100%;
	height: 100%;
	background-color: #C0C0C0;
}
</style>

<!-- LIBS-->
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.1.1/chroma.min.js"></script>
<script type='text/javascript' src="js/gamut.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r79/three.min.js"></script>
<script src="http://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script
	src='https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js'></script>
<script src="http://openlayers.org/en/v3.17.1/build/ol.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
</head>
<body>
	<!-- Application scripts-->
	<script>
		//Consts
		var NEUTRALGREY = 0xC0C0C0, DEFAULTLAYER = 'extrapalettor:pop_bretagne_1999_2010';
		//Globals
		var papp

		/*##########################################
		 *           Entry point 
		 *#########################################*/
		window.onload = function() {
			//Create the application
			pApp = new PaletteApp("extrapalettor").show();

			//Request a palette
			$
					.getJSON(
							"http://localhost:8080/geoxygene-palettes/build/sequence?n=5",
							function(jqXHR) {
								pApp.addPalette(new Palette(jqXHR));
							}).done(function() {
						console.log("Done");
					}).fail(
							function(jqXHR, textStatus, errorThrown) {
								console.log(jqXHR.responseText + "->"
										+ textStatus + " : " + errorThrown
										+ " error");
							})

		}

		/*##########################################
		 *           Application objects 
		 *#########################################*/

		function PaletteApp(appName) {

			//-----PRIVATE-----
			var name = appName, children = [];

			//-----PUBLIC-----
			this.container = null;

			this.add = function(child) {
				child.attachTo(this);
				children.push(child);
			};

			this.addPalette = function(palette) {
				children.forEach(function(child) {
					child.addPalette(palette);
				});
			};

			//-----PRIVILEGED-----
			this.show = function() {
				document.getElementsByTagName('body')[0]
						.appendChild(this.container);
				children.forEach(function(child) {
					child.show();
				});
				return this;
			};

			//-----CONSTRUCTOR -----
			//build a container for this app.
			this.container = document.createElement('div');
			this.container.id = name;
			this.container.className = "application";

			//The ColorSpace view is used to display a palette in the CIEL*a*b* color space.
			this.add(new ColorSpaceView('sRGBView'));
			this.add(new MapView('mapview'));

		};

		function ColorSpaceView(name) {

			//-----PRIVATE-----
			var parent, env, gamut, renderer, animate, ptex;

			//-----PUBLIC-----
			this.container = null;

			//-----PRIVILEGED-----
			this.attachTo = function(p) {
				parent = p;
			};

			this.show = function() {
				//Build a container for this view.
				this.container = document.createElement('div');
				this.container.id = name;
				this.container.className = "ColorSpaceView";
				parent.container.appendChild(this.container);

				renderer = new THREE.WebGLRenderer({
					antialias : true
				});
				// Set the background color of the scene to NEUTRALGREY to avoid distortions in color perception.
				renderer.setClearColor(NEUTRALGREY, 1);
				renderer.setSize(this.container.offsetWidth,
						this.container.offsetHeight);
				env = makeThreeEnvironment(this.container.offsetWidth,
						this.container.offsetHeight, renderer);
				gamut = new Gamut(5);

				//Add the gamut to the scene
				env.scene.add(gamut.shape);

				animate = function() {
					requestAnimationFrame(animate);
					renderer.render(env.scene, env.camera);
					env.controls.update();
				};

				//Add the parameter UI
				var gui = new dat.GUI();
				var gf = gui.addFolder('sRGB Gamut');
				gf.open();
				var lodController = gf.add(gamut, "detail", 1, 50);
				lodController.step(1);
				lodController.onChange(function(detail) {
					gamut.updateShapeDetails(detail);
				});

				gf.add(gamut.shape.material, "opacity", 0, 1).onChange(
						function(opacityValue) {
							gamut.shape.material.opacity = opacityValue;
						});

				gf.add(gamut.shape.material, "wireframe", true, false)
						.onChange(function(wireframeValue) {
							gamut.shape.material.wireframe = wireframeValue;
						});

				gf.add(gamut, "view", [ 'Full', 'Interior' ]).onChange(
						function(viewValue) {
							if (viewValue == "Full") {

								gamut.view = THREE.DoubleSide;
								gamut.shape.material.side = THREE.DoubleSide;
								gamut.shape.material.depthTest = true; //Re-enable the depth test to avoid weird rendering in DoubleSide mode.
							}
							if (viewValue == "Interior") {
								gamut.view = THREE.BackSide;
								gamut.shape.material.side = THREE.BackSide;
								gamut.shape.material.depthTest = false;
							}
						});

				//Show and render the scene
				this.container.appendChild(renderer.domElement);
				animate();

				//Load the resources
				ptex = new THREE.TextureLoader().load('images/circle.png');
				return this;
			};

			this.addPalette = function(palette) {
				palette.colors.forEach(function(c) {
					var sprite = new THREE.Sprite(new THREE.SpriteMaterial({
						map : ptex,
						color : c.hex()
					}));
					var clab = c.lab();
					sprite.position.set(clab[0], clab[1], clab[2]);
					sprite.scale.set(6, 6, 1.0);
					env.scene.add(sprite);
				});
			};

		};

		function MapView(name) {
			//-----PRIVATE-----
			var parent, sldBody, layer, map;

			//-----PUBLIC-----
			this.container = null;

			//-----PRIVILEGED-----
			this.attachTo = function(p) {
				parent = p;
			};
			sldBody = readTextFile("data/sld.xml");
			this.show = function() {
				//Build a container for this view.
				this.container = document.createElement('div');
				this.container.id = name;
				this.container.className = "MapView";
				parent.container.appendChild(this.container);

				map = new ol.Map({
					layers : [],
					target : name,
					view : new ol.View({
						center : [ -350000, 6100777 ],
						zoom : 8.0
					})
				});
				replaceLayer(DEFAULTLAYER);
				return this;
			};

			this.addPalette = function(palette) {
				palette.colors.forEach(function(c, id) {
					sldBody = sldBody.replace("$color" + (id + 1) + "$", c
							.hex());
				});
				replaceLayer(DEFAULTLAYER);
			};

			var replaceLayer = function(lname) {
				map.removeLayer(layer);
				layer = new ol.layer.Image({
					source : new ol.source.ImageWMS({
						url : 'http://5.39.77.233:8080/geoserver/wms',
						params : {
							layers : lname,
							sld_body : sldBody,
						},
						serverType : 'geoserver'
					})
				});
				map.addLayer(layer);

			};
		};

		//A PALETTE OBJECT
		function Palette(jsonObj) {

			this.colors = [];

			for (i = 0; i < jsonObj.colors.length; i++) {
				this.colors[i] = chroma(jsonObj.colors[i]);
			}

		};

		/*##########################################
		 *           Global functions 
		 *#########################################*/

		/**
		 * Builds a new ThreeJS Scene (with a Perspective Camera and a white Light)
		 */
		function makeThreeEnvironment(width, height, renderer) {

			//-----PRIVATE-----
			var scene = new THREE.Scene(), light, camera, controls, viewAngle = 45, aspect = width
					/ height, near = 0.1, far = 10000;

			// Create a camera, zoom it out from the model a bit, and add it to the scene.
			camera = new THREE.PerspectiveCamera(viewAngle, aspect, near, far);
			camera.position.set(250, -200, 0);

			// Camera controls
			controls = new THREE.OrbitControls(camera, renderer.domElement);
			controls.target = new THREE.Vector3(50, 0, 0); //Look at the NEUTRALGREY color

			//Debug axis
			scene.add(new THREE.AxisHelper(30));

			// Default light
			light = new THREE.AmbientLight(0xffffff);

			//Add everything in the scene
			scene.add(camera);
			scene.add(light);

			return {
				scene : scene,
				camera : camera,
				light : light,
				controls : controls
			};
		};

		function readTextFile(file) {
			var rawFile = new XMLHttpRequest(), allText;
			rawFile.open("GET", file, false);
			rawFile.onreadystatechange = function() {
				if (rawFile.readyState === 4) {
					if (rawFile.status === 200 || rawFile.status == 0) {
						allText = rawFile.responseText;
					}
				}
			}
			rawFile.send(null);
			return allText;
		};
	</script>
</body>
</html>
